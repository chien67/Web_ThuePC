@model DATN_Web.Models.ViewModels.CustomerDetailVM
@{
    ViewBag.Title = "Chi tiết khách hàng";
}
<section class="content">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
            <div class="row">
                <div class="col-md-6">
                    <!-- Line chart -->
                    <div class="card card-primary card-outline">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-building"></i>
                                Khách hàng
                            </h3>
                            <div class="project-actions text-right">
                                <a class="btn btn-danger btn-sm" style="" href="@Url.Action("EditCustomers","Customers")">
                                    Sửa thông tin
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="line-chart" style="height: 200px;">
                                <div>
                                    <h3 class="mb-2 font-weight-bold">@Model.Customer.CustomerName</h3>
                                </div>
                                <div>
                                    <ul class="list-unstyled">
                                        <li class="mb-1">
                                            <i class="fas fa-user mr-1"></i>
                                            Đại diện: <b>@Model.Customer.RepresentativeName</b>
                                        </li>
                                        <li>
                                            <i class="fas fa-phone mr-1"></i>
                                            Điện thoại: <b>@Model.Customer.Phone</b>
                                        </li>
                                    </ul>
                                </div>
                                <div>
                                    <i class="fas fa-id-card"></i> Thông tin MST/CCCD:: <b>@Model.Customer.TaxCode</b>
                                </div>
                                <div><i class="fas fa-map-marker-alt"></i> Địa chỉ: <b>@Model.Customer.Address</b></div>
                            </div>
                        </div>
                        <!-- /.card-body-->
                    </div>

                </div>
                <div class="col-md-6">
                    <!-- Bar chart -->
                    <div class="card card-primary card-outline">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="far fa-sticky-note"></i>
                                Ghi chú
                            </h3>
                        </div>
                        <div class="card-body">
                            <textarea name="ghichukhachhang" id="ghichukhachhang" class="form-control" disabled=""></textarea>
                        </div>
                        <!-- /.card-body-->
                    </div>
                    <!-- /.card -->
                </div>
            </div>

            <div class="card card-success">
                <div class="card-header">
                    <h3 class="card-title">Đơn hàng</h3>
                    <div class="project-actions text-right">
                        <div class="btn-group ">
                            <a class="btn btn-primary"
                               href="@Url.Action("CreateOrder", "Orders", new { customerId = Model.Customer.CustomerId })">
                                <i class="fas fa-plus"></i> Thêm mới
                            </a>
                        </div>
                    </div>
                    <!-- /.card-body -->
                </div>
                <div class="card-body p-0">
                    @{
                        Func<byte, string> statusText = s =>
                        {
                            switch (s)
                            {
                                case 0: return "Chuẩn bị";
                                case 1: return "Hoạt động";
                                case 2: return "Quá hạn";
                                case 3: return "Kết thúc";
                                default: return "Không rõ";
                            }
                        };

                        Func<byte, string> statusCss = s =>
                        {
                            switch (s)
                            {
                                case 0: return "badge badge-warning";   // Chuẩn bị
                                case 1: return "badge badge-primary";   // Đã giao
                                case 2: return "badge badge-danger";    // Quá hạn
                                case 3: return "badge badge-success";   // Kết thúc
                                default: return "badge badge-dark";
                            }
                        };
                    }
                    <table id="ordersTable" class="table table-bordered table-hover mb-0">
                        <thead class="text-center">
                            <tr>
                                <th>Ngày giao</th>
                                <th>Nội dung</th>
                                <th>Tình trạng</th>
                                <th>Số ngày</th>
                                <th>Hết hạn</th>
                                <th style="width:90px;"></th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (Model.Orders != null && Model.Orders.Any())
                            {
                                foreach (var o in Model.Orders.Where(x => x.Status != 3))
                                {
                                    // Hết hạn: DeliveryDate + RentDays (đúng như hình bạn gửi)
                                    var expire = o.DeliveryDate.HasValue
                                        ? o.DeliveryDate.Value.Date.AddDays(o.RentDays)
                                        : (DateTime?)null;

                                    <tr>
                                        <td class="text-center align-middle">
                                            @(o.DeliveryDate?.ToString("dd/MM/yyyy"))
                                        </td>
                                        <td class="align-middle">
                                            <div class="text-primary fw-bold">
                                                Yêu cầu: @o.DeviceRequirement
                                            </div>
                                            <div class="text-primary fw-bold">
                                                Thông tin: | @o.Quantity Máy | @o.RentDays Ngày | @String.Format("{0:N0}", o.UnitPrice) VNĐ |
                                            </div>
                                            <div>
                                                <a href="@Url.Action("Detail","Orders", new { id = o.OrderId })">► Chi tiết</a>
                                            </div>
                                        </td>

                                        <!-- Tình trạng -->
                                        @{
                                            var displayStatus = o.Status;
                                            if (expire.HasValue && DateTime.Today >= expire.Value.Date)
                                            {
                                                displayStatus = 2; // Quá hạn
                                            }
                                        }
                                        <td class="text-center align-middle">
                                            <span class="@statusCss(o.Status)">@statusText(o.Status)</span>
                                        </td>

                                        <!-- Số ngày -->
                                        <td class="text-center align-middle">
                                            @o.RentDays ngày
                                        </td>

                                        <!-- Hết hạn -->
                                        <td class="text-center align-middle">
                                            @(expire?.ToString("dd/MM/yyyy"))
                                        </td>

                                        <!-- Action -->
                                        <td class="text-center align-middle">
                                            <a class="btn btn-info btn-sm"
                                               href="@Url.Action("Edit","Orders", new { id = o.OrderId })">
                                                Xem
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card card-success">
                <div class="card-header">
                    <h3 class="card-title">Thiết bị</h3>
                    <div class="project-actions text-right">
                        <div class="btn-group ">
                            <a class="btn btn-primary"
                               href="@Url.Action("Create", "CustomerDevices", new { customerId = Model.Customer.CustomerId })">
                                <i class="fas fa-plus"></i> Thêm mới
                            </a>
                            <a class="btn btn-info" href="@Url.Action("EditCustomers","Customers")">
                                <i class="fas fa-pencil-alt">
                                </i>
                                Thu hồi
                            </a>
                        </div>
                    </div>
                    <!-- /.card-body -->
                </div>
                <div class="card-body">
                    <table id="devicesTable" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Ngày giao</th>
                                <th>Danh mục</th>
                                <th>Model</th>
                                <th>Cấu hình</th>
                                <th>Số lượng</th>
                                <th>Chức năng</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.CustomerDevices == null || !Model.CustomerDevices.Any())
                            {
                                @* để trống cho DataTables emptyTable *@
                            }
                            else
                            {
                                foreach (var d in Model.CustomerDevices)
                                {
                                    <tr>
                                        <td class="text-center align-middle">@(d.DeliveryDate?.ToString("dd/MM/yyyy"))</td>
                                        <td class="text-center align-middle">
                                            <span class="badge badge-primary">@d.CategoryName</span>
                                        </td>
                                        <td class="align-middle">@d.ModelName</td>
                                        <td class="align-middle">@d.Configuration</td>
                                        <td class="text-center align-middle">@d.Quantity</td>
                                        <td class="text-center align-middle">
                                            <a class="btn btn-outline-dark btn-sm"
                                               href="@Url.Action("Return", "CustomerDevices", new { id = d.Id })">
                                                Thu hồi
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card card-success card-outline">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-edit"></i>
                        Lịch Sử Cập nhập
                    </h3>
                </div>
                <div class="card-body">
                </div>
            </div>
        </div>
    </div>
</section>
@section Scripts {
    <script>
        // ORDERS TABLE
        if (!$.fn.DataTable.isDataTable('#ordersTable')) {
            $('#ordersTable').DataTable({
                lengthChange: false,
                responsive: true,
                autoWidth: false,
                pageLength: 10,

                columnDefs: [
                    { targets: -1, orderable: false }
                ],

                language: {
                    emptyTable: `
                        <div class="py-4 text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <div class="font-weight-bold">Chưa có đơn hàng</div>
                            <div class="small">Nhấn <b>Thêm mới</b> để tạo đơn hàng đầu tiên</div>
                        </div>
                    `,
                    zeroRecords: "Không tìm thấy dữ liệu phù hợp"
                },

                drawCallback: function () {
                    const api = this.api();
                    const hasData = api.rows({ filter: 'applied' }).data().length > 0;
                    const $wrap = $(api.table().container());

                    $wrap.find('.dataTables_filter').toggle(hasData);
                    $wrap.find('.dataTables_length').toggle(hasData);
                    $wrap.find('.dataTables_paginate').toggle(hasData);
                    $wrap.find('.dataTables_info').toggle(hasData);
                }
            });
        }
        //deivecmodel
        $(function () {

            // DEVICES TABLE - gọn như mẫu
            if (!$.fn.DataTable.isDataTable('#devicesTable')) {
                $('#devicesTable').DataTable({
                    responsive: true,
                    autoWidth: false,

                    // Ẩn toàn bộ control giống mẫu
                    searching: false,
                    paging: false,
                    info: false,
                    lengthChange: false,

                    // Tắt sort cột "Chức năng" (cột cuối)
                    columnDefs: [{ targets: -1, orderable: false }],

                    language: {
                        emptyTable: "Không có dữ liệu"
                    }
                });
            }

        });
    </script>
}
@section Styles {
    <style>
        #ordersTable_wrapper .dataTables_filter {
            margin-top: 12px;
            margin-right: 12px;
        }
    </style>
}